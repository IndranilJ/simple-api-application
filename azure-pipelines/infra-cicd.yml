trigger:
  branches:
    include:
      - main
  paths:
    include:
      - terraform/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  TF_IN_AUTOMATION: 'true'
  TF_INPUT: 'false'
  PROJECT_ID: 'test-sample-api-479708'
  REGION: 'asia-south1'

steps:
- task: DownloadSecureFile@1
  name: gcpKey
  inputs:
    secureFile: 'gcp-sa-key.json' # upload in Library â†’ Secure files

- script: |
    sudo apt-get update && sudo apt-get install -y jq
    echo "Setting up gcloud..."
    curl -sSL https://sdk.cloud.google.com | bash
    source "$HOME/google-cloud-sdk/path.bash.inc"
    gcloud auth activate-service-account --key-file $(gcpKey.secureFilePath)
    gcloud config set project $(PROJECT_ID)
    gcloud auth application-default login --key-file=$(gcpKey.secureFilePath)
  displayName: 'Authenticate with GCP'

- task: TerraformInstaller@0
  inputs:
    terraformVersion: '1.6.6'

- script: |
    cd terraform
    terraform init
    terraform plan -var-file=env.tfvars -out=plan.out
  displayName: 'Terraform plan'

# Optional manual approval gate can be added here with Environments

- script: |
    cd terraform
    terraform apply -auto-approve plan.out
  displayName: 'Terraform apply'
